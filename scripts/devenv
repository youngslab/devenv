#!/bin/bash
# DevEnv container launcher
# - 백그라운드에서 실행되어 SSH 세션 종료 후에도 유지
# - 자동 재시작 (unless-stopped)
# - noVNC 포트(7901) 기본 활성화
#
# Usage: devenv [-f|--force] [command]
#   -f, --force  Force recreate container (removes existing)

IMAGE_NAME="devenv"
CONTAINER_NAME="devenv"
USERNAME=$(whoami)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEVENV_DIR="$(dirname "$SCRIPT_DIR")"

# Load .env file if exists
ENV_FILE="${DEVENV_DIR}/.env"
ENV_FILE_ARG=""
if [[ -f "$ENV_FILE" ]]; then
  ENV_FILE_ARG="--env-file $ENV_FILE"
fi

# Parse options
FORCE_RECREATE=false
ARGS=()
for arg in "$@"; do
  case "$arg" in
    -f|--force)
      FORCE_RECREATE=true
      ;;
    *)
      ARGS+=("$arg")
      ;;
  esac
done
set -- "${ARGS[@]}"

# Show MOTD banner (for SSH RemoteCommand)
cat /etc/motd 2>/dev/null

WORKSPACE_DIR="$HOME/workspace"
DOTFILES_DIR="$HOME/workspace/devenv/dotfiles"

# Named volume for container home (persistent across restarts)
# Replace dots in username for valid volume name
SAFE_USERNAME="${USERNAME//./-}"
HOME_VOLUME="devenv-home-${SAFE_USERNAME}"

# 마운트할 디렉토리 미리 생성 (없으면 Docker가 root로 생성해서 권한 문제 발생)
mkdir -p "$HOME/.claude"
mkdir -p "$HOME/.config/gh"
mkdir -p "$HOME/.config/github-copilot"

# Force recreate: 기존 컨테이너 삭제
if [ "$FORCE_RECREATE" = true ]; then
  if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "Removing existing container..."
    docker rm -f "$CONTAINER_NAME" >/dev/null
  fi
fi

# 이미 실행 중이면 exec으로 접속
if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
  exec docker exec -it --detach-keys='ctrl-@' --user "$(id -u):$(id -g)" "$CONTAINER_NAME" "${@:-zsh}"
fi

# 중지된 컨테이너가 있으면 시작 후 접속
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
  echo "Starting stopped container..."
  docker start "$CONTAINER_NAME"
  sleep 1
  exec docker exec -it --detach-keys='ctrl-@' --user "$(id -u):$(id -g)" "$CONTAINER_NAME" "${@:-zsh}"
fi

# Volume 초기화 (비어있으면 권한 설정)
if ! docker volume inspect "$HOME_VOLUME" &>/dev/null; then
  echo "Creating volume with correct permissions..."
  docker volume create "$HOME_VOLUME"
fi

# Volume 권한 확인 및 수정 (root로 실행)
docker run --rm \
  -v "${HOME_VOLUME}:/home/${USERNAME}" \
  "$IMAGE_NAME" \
  chown -R "$(id -u):$(id -g)" "/home/${USERNAME}" 2>/dev/null

# Docker 그룹 GID (호스트)
DOCKER_GID=$(getent group docker 2>/dev/null | cut -d: -f3)

# --group-add 옵션 구성
GROUP_OPTS="--group-add sudo"
[ -n "$DOCKER_GID" ] && GROUP_OPTS="$GROUP_OPTS --group-add $DOCKER_GID"

echo "Starting devenv container..."

# 백그라운드로 컨테이너 실행 (tail -f로 유지)
docker run -d \
  --name "$CONTAINER_NAME" \
  --hostname "$(hostname -s)" \
  --user "$(id -u):$(id -g)" \
  --restart unless-stopped \
  --network host \
  $GROUP_OPTS \
  $ENV_FILE_ARG \
  -e HOME="/home/${USERNAME}" \
  -e USER="${USERNAME}" \
  -e CONTAINER_NAME="${CONTAINER_NAME}" \
  --shm-size=2g \
  -v "${HOME_VOLUME}:/home/${USERNAME}" \
  -v "$WORKSPACE_DIR:/home/$USERNAME/workspace" \
  -v "$DOTFILES_DIR:/home/$USERNAME/.dotfiles" \
  -v "$HOME/.claude:/home/$USERNAME/.claude" \
  -v "$HOME/.claude.json:/home/$USERNAME/.claude.json" \
  -v "$HOME/.config/gh:/home/$USERNAME/.config/gh" \
  -v "$HOME/.config/github-copilot:/home/$USERNAME/.config/github-copilot" \
  -v "$HOME/.ssh:/home/$USERNAME/.ssh" \
  -v "$HOME/.gnupg:/home/$USERNAME/.gnupg:ro" \
  -v /var/run/docker.sock:/var/run/docker.sock \
  "$IMAGE_NAME" \
  tail -f /dev/null

# 컨테이너가 시작될 때까지 대기
sleep 1

# exec으로 접속 (detach-keys 변경: Ctrl+P 충돌 방지)
exec docker exec -it --detach-keys='ctrl-@' --user "$(id -u):$(id -g)" "$CONTAINER_NAME" "${@:-zsh}"
